"use strict";var _interopRequireWildcard=require("@babel/runtime/helpers/interopRequireWildcard"),_interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty")),_vue=_interopRequireDefault(require("vue")),_jquery=_interopRequireDefault(require("jquery")),_Page=_interopRequireDefault(require("./Page")),_Router=_interopRequireWildcard(require("./Router")),_BorasdCast=_interopRequireDefault(require("./BorasdCast"));function readyPromise(){return new Promise(function(e){(0,_jquery.default)(window.document).ready(function(){e()})})}function DOMContentLoadedPromise(){return new Promise(function(e){window.addEventListener("DOMContentLoaded",function(){e()})})}function devicereadyPromise(){return new Promise(function(e){window.document.addEventListener("deviceready",function(){e()})})}function _fireEvent(e,t){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[];(0,_jquery.default)(e).trigger(t,i)}function _createPage(u,d){var c=this;return new Promise(function(e,r){var a=u.substring(0,u.lastIndexOf("_")),t=c.getPageConfigAttribute(a,"mode"),i=c.getSingleInstance(a);if(-1!==t.toLowerCase().indexOf("singleinstance")&&i)d&&d(i),e();else{var o,s=c.config.router[a];if(s){var n=s.component;n&&n.then?n.then(function(e){if(e){o=e.default;var t=(0,_jquery.default)('<div data-ct-data-role="page"></div>')[0],i=(0,_jquery.default)("<div></div>")[0];t.appendChild(i),document.body.appendChild(t);var n="ctmobile-".concat(a.toLowerCase());new _vue.default(Object.assign(new _Page.default({ctmobile:c,id:u,el:t,config:s.config||{},callback:d}),{el:i,data:{_pDom:t,pageId:a},template:"<".concat(n,' :_pDom="_pDom" :pageId="pageId" />'),components:(0,_defineProperty2.default)({},n,o)}))}else r()}).catch(function(e){r(e)}):r()}else r()}})}function onReady(){var r=this;this.hasInited||(this.hasInited=!0,this.bodyDOM=window.document.body,this.singleInstances=null,this.maskDOM=(0,_jquery.default)("<div class='ct-page-mask'> <div opt='animation' class='la-ball-circus la-dark' style='color:#3e98f0;'>   <div></div>   <div></div>   <div></div>   <div></div>   <div></div> </div></div>")[0],this.bodyDOM.appendChild(this.maskDOM),_fireEvent(window.document,"pageBeforeChange",[CtMobileFactory.getUrlParam(window.location.hash)]),_createPage.call(this,this.getFirstId(),function(e){e.start(0,function(){if(!window.location.hash)return!1;var e=r.getPageIdByHash();if(!e)return!1;var t="#".concat(e),i=r.getParameterByHash(),n=CtMobileFactory.getUrlParam("".concat(t).concat(i));r.startPage("".concat(t).concat(i).concat(i?n.pageId?"":"&pageId=".concat(e):"?pageId=".concat(e)),{reload:r.config.linkCaptureReload})})}))}function init(){var e=this.config.supportCordova,t=void 0!==e&&e;onReady=onReady.bind(this),t?Promise.all([readyPromise(),DOMContentLoadedPromise(),devicereadyPromise()]).then(function(){onReady(),_fireEvent(window.document,"DOMContentAndDeviceReady")}).catch(function(e){}):((0,_jquery.default)(window.document).ready(onReady),window.addEventListener("DOMContentLoaded",onReady))}var CtMobile=function(){function t(e){(0,_classCallCheck2.default)(this,t),this.config=e,this.hasInited=!1,this.zIndex=0,this.router=new _Router.default(this),this.borasdcast=new _BorasdCast.default,init.call(this)}return(0,_createClass2.default)(t,[{key:"startPage",value:function(e,t){this.router.startPage(e,t)}},{key:"createPage",value:function(e,t){return _createPage.call(this,e,t)}},{key:"back",value:function(){this.router.go(-1)}},{key:"getPageConfigAttribute",value:function(e,t){var i=this.config.router[e];if(i.config){var n=i.config[t];if(!n)switch(t){case"mode":n="standard";break;case"transition":n="material"}return n}var r="";switch(t){case"mode":r="standard";break;case"transition":r="material"}return r}},{key:"getFirstId",value:function(){return this.getId(this.getFirstPageId())}},{key:"getId",value:function(e){var t=e.indexOf("?");return-1!==t?e.substring(0,t)+"_"+(new Date).getTime()+e.substring(t):e+"_"+(new Date).getTime()}},{key:"getPageIdByHash",value:function(){var e=window.location.hash;return e?-1!==e.indexOf("?")?(e=e.substring(0,e.lastIndexOf("?"))).substring(1,e.lastIndexOf("_")):e.substring(1,e.lastIndexOf("_")):""}},{key:"getParameterByHash",value:function(){var e=window.location.hash;return e&&-1!==e.indexOf("?")?e.substring(e.lastIndexOf("?")):""}},{key:"getFirstPageId",value:function(){var e;for(var t in this.config.router)if(this.config.router[t].isFirst){e=t;break}return e||"index"}},{key:"getPageById",value:function(e){return this.router.getPageById(this.indexOfById(e))}},{key:"getSingleInstance",value:function(e){return this.singleInstances||(this.singleInstances={}),this.singleInstances[e]}},{key:"fireEvent",value:function(e,t,i){_fireEvent(e,t,i)}},{key:"getPageByIndex",value:function(e){return this.router.getPageByIndex(e)}},{key:"indexOfById",value:function(e){for(var t=-1,i=0,n=this.getHistoryLength();i<n;i++)if(this.getPageByIndex(i).getId()===e){t=i;break}return t}},{key:"getFirstPage",value:function(){return this.router.getPageByIndex(0)}},{key:"getLastPage",value:function(){return this.router.getLastPage()}},{key:"getParameter",value:function(){return this.router.getParameter()}},{key:"getHistoryLength",value:function(){return this.router.getHistoryLength()}},{key:"getRequest",value:function(e){if(0===this.getHistoryLength()||1===this.getHistoryLength())return{};var t=this.indexOfById(e.getId());return t<=0||t>this.getHistoryLength()-1?{}:this.getPageByIndex(this.getHistoryLength()-2).requestIntent||{}}},{key:"registerReceiver",value:function(e,t,i){this.borasdcast.registerReceiver(e,t,i)}},{key:"executeReceiverById",value:function(e,t){this.borasdcast.executeReceiverById(e,t)}},{key:"unregisterReceiver",value:function(e,t){this.borasdcast.unregisterReceiver(e,t)}},{key:"unregisterReceiverByDom",value:function(e){this.borasdcast.unregisterReceiverByDom(e)}},{key:"sendBroadcast",value:function(e){this.borasdcast.sendBroadcast(e)}},{key:"sendOrderedBroadcast",value:function(e){this.borasdcast.sendOrderedBroadcast(e)}}]),t}();function CtMobileVuePlugin(i){return{install:function(e){var t={beforeCreate:function(){Object.assign(this,{$ctmobile:i})}};e.mixin({components:{"ctmobile-link":Object.assign(Object.create(_Router.Link),{mixins:[t]}),"ctmobile-back":Object.assign(Object.create(_Router.Back),{mixins:[t]})}})}}}var CtMobileFactory={getUrlParam:function(e){var t=/([^&=]+)=([\w\W]*?)(&|$)/g,i=/^[^\?]+\?([\w\W]+)$/.exec(e),n={};if(i&&i[1])for(var r,a=i[1];null!=(r=t.exec(a));)n[r[1]]=decodeURI(r[2]);return n},create:function(e){var t=new CtMobile(e);return _vue.default.use(CtMobileVuePlugin(t)),t}},_default=CtMobileFactory;exports.default=_default;