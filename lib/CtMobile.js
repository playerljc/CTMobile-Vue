"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_react=_interopRequireDefault(require("react")),_reactDom=_interopRequireDefault(require("react-dom")),_jquery=_interopRequireDefault(require("jquery")),_Page=_interopRequireDefault(require("./Page")),_Router=_interopRequireDefault(require("./Router")),_BorasdCast=_interopRequireDefault(require("./BorasdCast"));function readyPromise(){return new Promise(function(e){(0,_jquery.default)(window.document).ready(function(){e()})})}function DOMContentLoadedPromise(){return new Promise(function(e){window.addEventListener("DOMContentLoaded",function(){e()})})}function devicereadyPromise(){return new Promise(function(e){window.document.addEventListener("deviceready",function(){e()})})}function _fireEvent(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[];(0,_jquery.default)(e).trigger(t,r)}function _createPage(u,d){var c=this;return new Promise(function(n,i){var e=u.substring(0,u.lastIndexOf("_")),t=c.getPageConfigAttribute(e,"mode"),r=c.getSingleInstance(e);if(-1!==t.toLowerCase().indexOf("singleinstance")&&r)d&&d(r),n();else{var a,o=c.config.router[e];if(o){var s=o.component;s&&s.then?s.then(function(e){if(e){a=e.default;var t=(0,_jquery.default)('<div data-ct-data-role="page"></div>')[0];document.body.appendChild(t);var r=_Page.default.create(t)(a);_reactDom.default.render(_react.default.createElement(r,{ctmobile:c,id:u,config:o.config||{},callback:d}),t,function(){n()})}else i()}).catch(function(e){i(e)}):i()}else i()}})}function onReady(){var i=this;this.hasInited||(this.hasInited=!0,this.bodyDOM=window.document.body,this.singleInstances=null,this.maskDOM=(0,_jquery.default)("<div class='ct-page-mask'> <div opt='animation' class='la-ball-circus la-dark' style='color:#3e98f0;'>   <div></div>   <div></div>   <div></div>   <div></div>   <div></div> </div></div>")[0],this.bodyDOM.appendChild(this.maskDOM),_fireEvent(window.document,"pageBeforeChange",[CtMobileFactory.getUrlParam(window.location.hash)]),_createPage.call(this,this.getFirstId(),function(e){e.start(0,function(){if(!window.location.hash)return!1;var e=i.getPageIdByHash();if(!e)return!1;var t="#".concat(e),r=i.getParameterByHash(),n=CtMobileFactory.getUrlParam("".concat(t).concat(r));i.startPage("".concat(t).concat(r).concat(r?n.pageId?"":"&pageId=".concat(e):"?pageId=".concat(e)),{reload:i.config.linkCaptureReload})})}))}function init(){var e=this.config.supportCordova,t=void 0!==e&&e;onReady=onReady.bind(this),t?Promise.all([readyPromise(),DOMContentLoadedPromise(),devicereadyPromise()]).then(function(){onReady(),_fireEvent(window.document,"DOMContentAndDeviceReady")}).catch(function(e){}):((0,_jquery.default)(window.document).ready(onReady),window.addEventListener("DOMContentLoaded",onReady))}var CtMobile=function(){function t(e){(0,_classCallCheck2.default)(this,t),this.config=e,this.hasInited=!1,this.zIndex=0,this.router=new _Router.default(this),this.borasdcast=new _BorasdCast.default,init.call(this)}return(0,_createClass2.default)(t,[{key:"startPage",value:function(e,t){this.router.startPage(e,t)}},{key:"createPage",value:function(e,t){return _createPage.call(this,e,t)}},{key:"back",value:function(){this.router.go(-1)}},{key:"getPageConfigAttribute",value:function(e,t){var r=this.config.router[e];if(r.config){var n=r.config[t];if(!n)switch(t){case"mode":n="standard";break;case"transition":n="material"}return n}var i="";switch(t){case"mode":i="standard";break;case"transition":i="material"}return i}},{key:"getFirstId",value:function(){return this.getId(this.getFirstPageId())}},{key:"getId",value:function(e){var t=e.indexOf("?");return-1!==t?e.substring(0,t)+"_"+(new Date).getTime()+e.substring(t):e+"_"+(new Date).getTime()}},{key:"getPageIdByHash",value:function(){var e=window.location.hash;return e?-1!==e.indexOf("?")?(e=e.substring(0,e.lastIndexOf("?"))).substring(1,e.lastIndexOf("_")):e.substring(1,e.lastIndexOf("_")):""}},{key:"getParameterByHash",value:function(){var e=window.location.hash;return e&&-1!==e.indexOf("?")?e.substring(e.lastIndexOf("?")):""}},{key:"getFirstPageId",value:function(){var e;for(var t in this.config.router)if(this.config.router[t].isFirst){e=t;break}return e||"index"}},{key:"getPageById",value:function(e){return this.router.getPageById(this.indexOfById(e))}},{key:"getSingleInstance",value:function(e){return this.singleInstances||(this.singleInstances={}),this.singleInstances[e]}},{key:"fireEvent",value:function(e,t,r){_fireEvent(e,t,r)}},{key:"getPageByIndex",value:function(e){return this.router.getPageByIndex(e)}},{key:"indexOfById",value:function(e){for(var t=-1,r=0,n=this.getHistoryLength();r<n;r++)if(this.getPageByIndex(r).getId()===e){t=r;break}return t}},{key:"getFirstPage",value:function(){return this.router.getPageByIndex(0)}},{key:"getLastPage",value:function(){return this.router.getLastPage()}},{key:"getParameter",value:function(){return this.router.getParameter()}},{key:"getHistoryLength",value:function(){return this.router.getHistoryLength()}},{key:"getRequest",value:function(e){if(0===this.getHistoryLength()||1===this.getHistoryLength())return{};var t=this.indexOfById(e.getId());return t<=0||t>this.getHistoryLength()-1?{}:this.getPageByIndex(this.getHistoryLength()-2).requestIntent||{}}},{key:"registerReceiver",value:function(e,t,r){this.borasdcast.registerReceiver(e,t,r)}},{key:"executeReceiverById",value:function(e,t){this.borasdcast.executeReceiverById(e,t)}},{key:"unregisterReceiver",value:function(e,t){this.borasdcast.unregisterReceiver(e,t)}},{key:"unregisterReceiverByDom",value:function(e){this.borasdcast.unregisterReceiverByDom(e)}},{key:"sendBroadcast",value:function(e){this.borasdcast.sendBroadcast(e)}},{key:"sendOrderedBroadcast",value:function(e){this.borasdcast.sendOrderedBroadcast(e)}}]),t}(),CtMobileFactory={getUrlParam:function(e){var t=/([^&=]+)=([\w\W]*?)(&|$)/g,r=/^[^\?]+\?([\w\W]+)$/.exec(e),n={};if(r&&r[1])for(var i,a=r[1];null!=(i=t.exec(a));)n[i[1]]=decodeURI(i[2]);return n},create:function(e){return new CtMobile(e)}},_default=CtMobileFactory;exports.default=_default;